#!/usr/bin/env ruby -KU

require 'thor'
require 'net/https'
require 'dotenv'

Dotenv.load

class Hipchat < Thor

  desc 'say', 'Say a thing to a room'

  method_option :message,    :type => :string, :required => true
  method_option :auth_token, :default => ENV[ 'HIPCHAT_AUTH_TOKEN' ]
  method_option :room_id,    :default => 'ROBOTS ONLY'
  method_option :from,       :default => 'Deploy'
  method_option :notify,     :type => :boolean, :default => '1'
  method_option :color,      :type => :string

  default_task :say

  def say
    uri  = URI 'https://api.hipchat.com/v1/rooms/message'

    req  = Net::HTTP::Post.new uri.path
    req.set_form_data options

    http = Net::HTTP.new uri.host, uri.port
    http.use_ssl = true

    http.request req
  end
end

Hipchat.start
